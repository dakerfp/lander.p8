pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- lander
-- version 0.1
-- author @dakerfp

ship={}
planet={}

function has(l,o)
	for e in all(l) do
		if (e == o) return true
	end
	return false
end

function hmappair(hmap,x)
	last = hmap[1]
	for i=2,#hmap do
		p = hmap[i]
		if x < p.x then
			return last, p
		end
		last = p
	end
	-- will fail
end

function islanding(hmap, x)
	p0,p1=hmappair(hmap,x)
	return p0.landing
end

function heightmap(f,x)
	last, cur = hmappair(hmap,x)
	t = (x-last.x)/(cur.x-last.x)
	return last.y + t * (cur.y-last.y)
end

function genhmap(len,y0,vary)
	hmap = {}
	lpad=1+flr(rnd(len-1))
	for i=1,len+1 do
		landing = i==lpad
		p = {
			x=128 * (i-1) / len,
			y=y0,
			landing=landing
		}
		if not landing then
			-- do not slope on landing pad
			y0+=rnd(2*vary)-vary
			y0=mid(64,y0,127)
		end
		add(hmap,p)
	end
	return hmap
end

function _init()
	ship = {x=32,y=0,
									vx=0,vy=0,
									hthrust=0.1,
									vthrust=0.2,
									fuel=128,
									fuelcons=1,
									landed=false,
									state="intro"}
	hmap = genhmap(16,120,10)
	planet = {g=0.05,crashvel=1,hmap=hmap}
end

function _update()
	if ship.state == "intro" then
		if btnp(❎) then
			ship.state = "idle"
		end
		return
	end

	if has({"landed","crashed"},
		ship.state) then
		if btnp(❎) then
			_init()
			ship.state="idle"
		end
		return
	end

	-- momentum update
	if btn(⬅️) and ship.fuel > 0 then
		ship.vx -= ship.hthrust
		ship.fuel -= ship.fuelcons
		ship.state = "thrust"
	else
		ship.state = "idle"
	end
	if btn(➡️) and ship.fuel > 0 then
		ship.vx += ship.hthrust
		ship.fuel -= ship.fuelcons
		ship.state = "thrust"
	else
		ship.state = "idle"
	end
	if btn(⬆️) and ship.fuel > 0 then
		ship.vy -= ship.vthrust
		ship.fuel -= ship.fuelcons
		ship.state = "thrust"
	else
		ship.state = "idle"
	end

	ship.vy += planet.g
	-- inertial update
	ship.x += ship.vx
	ship.y += ship.vy
	-- collision check
	if ship.x < 0
		or ship.x + 8 > 128 then
		ship.state="crashed"
		return
	end
	lx=ship.x+4
	if ship.y + 8 > heightmap(planet.hmap,lx) then -- 8 is sprite width
		if ship.vy < planet.crashvel
			and islanding(planet.hmap,lx) then
			ship.state="landed"
		else
			ship.state="crashed"
		end
	end
end

function _draw()
	if ship.state == "intro" then
		draw_title()
		return
	end

	cls()
	-- landscape and hud	
	line(0,0,ship.fuel,0,8) -- red
	last = planet.hmap[1]
	for p in all(planet.hmap) do
		c = 13 -- purple
		if (last.landing) c=10 -- yellow
		line(last.x,last.y,p.x,p.y,c)
		last = p
	end
	-- ship
	if ship.state == "crashed" then
		print("game over", 48, 64)
		spr(0,ship.x,ship.y)
		print_blinking("press ❎ to restart", 30, 80)
	else
		if ship.state == "landed" then
			print("landed!", 52, 64)
			spr(3,ship.x,ship.y-7)
		end
		spr(1,ship.x,ship.y)
		if ship.state == "thrust" then
			spr(2,ship.x,ship.y+7)
		end
	end
end

blink=0
function print_blinking(s,x,y)
	blink=(blink+1)%30
	if blink > 15 then
		print(s, x,y,7)
	end
end

function draw_title()
	cls(1)
	rectfill(0,62,64,128,13)
	rectfill(0,69,128,128,13)
	line(0,61,64,63,5)
	line(96,68,128,69,5)
	spr(64,32,32,8,8)
	print_blinking("press ❎ to start",30,16)
	print("landing",52,95,2)
	print("landing",52+1,95+1,7)
	print("@dakerfp",95,121,2)
	print("@dakerfp",95+1,121+1,7)
end
__gfx__
000000000000070000988900c7c78008000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000777700098888907c7c7887007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000070070000999900c7c78778007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000000000068887887007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000700000000006778778070000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070080070770700000000006880880070770700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07667760077777700000000006000000077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
68867677770000770000000000600000770000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
1111111115d6cc111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111111d76cc1111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
1111111676cc11111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
111111dc6ccc11111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
111115cc6cc111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111d66ccc111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111666ccc111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11111676ccc111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
11115677cc1111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000
111116776cc111111111111111111111111111111111111111111511111111110000000000000000000000000000000000000000000000000000000000000000
111116766c11111111111111111111111111111115945dd5d555dd11111111110000000000000000000000000000000000000000000000000000000000000000
11111d776c11111111111111111111111111111115a44d6dd51dd551111111110000000000000000000000000000000000000000000000000000000000000000
111115676c11111111111111111111111111111111556777767d5565111111110000000000000000000000000000000000000000000000000000000000000000
111111d7cc111111111111111111111111115d6d11566777f57755d1155111110000000000000000000000000000000000000000000000000000000000000000
1111111d6cc1111111111111111111111111d77d5d77777765dd5551677d11110000000000000000000000000000000000000000000000000000000000000000
11111111d6c1111111111111111111111111677dd77777776515111111d511110000000000000000000000000000000000000000000000000000000000000000
111111111151111111111111111111111111677d5777777765111111115511110000000000000000000000000000000000000000000000000000000000000000
111111111111111111111111111111111111677d5777777765111111115511110000000000000000000000000000000000000000000000000000000000000000
111111111111111111111111111111111111677d5777777765111111115511110000000000000000000000000000000000000000000000000000000000000000
111111111111111111111111111111111111677d5777777765111111111511110000000000000000000000000000000000000000000000000000000000000000
111111111111111111111111111111111111776d56567777d5111111111511110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111167645f77777765111111111511110000000000000000000000000000000000000000000000000000000000000000
111111111111111111111111111111111111776d5f77777765151111111511110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111177fddfff7777d5051111155511110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111177f5d7777777d5155115515511110000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111111111111111177fd6f6df777d5155155515511110000000000000000000000000000000000000000000000000000000000000000
5555511111111111111111111111111111115d4545554f6d55005151115511110000000000000000000000000000000000000000000000000000000000000000
dd55d5555551111111111111111111111ddd6faff49f4f4455555155111111110000000000000000000000000000000000000000000000000000000000000000
ddddd5555ddd5555555111111111111156d5aaaaa49aaa7f9445555555555d510000000000000000000000000000000000000000000000000000000000000000
5ddddddddddddddddddd55551111111165d4aaaa6dfaaaff4445555544941dd50000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddddddddddd5555556516aaaa444aaafd444555554444d1d50000000000000000000000000000000000000000000000000000000000000000
ddddddddddddddddddddddddddddddd6ddd6aaaf444aa9f444455555444451560000000000000000000000000000000000000000000000000000000000000000
ddddddd5ddddddddddddddddddddddd6dddfaaaa44da4af99445555544445dd60000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddddd6ddddddddd75dddfafaf44dfaaf9945555454444dddd0000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddddddddddd5ddd6ddd66ff7444f9aa7a994554454f44dddd0000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddd5555dd5555575dddd4ff66766faa7999455555d455dddd0000000000000000000000000000000000000000000000000000000000000000
dddddddd555555dd655555d55dddd65ddd6d6f44446fff76655555545445dddd0000000000000000000000000000000000000000000000000000000000000000
dddddddd55dd55ddd555d5dddddd75d666ddd554456a9a7994455544444ddddd0000000000000000000000000000000000000000000000000000000000000000
ddddddddddddddddd555555555d6666d5ddddddddd66d4744455ddd555dddddd0000000000000000000000000000000000000000000000000000000000000000
6d6d5ddddddddd655dddddddddd6dd15ddddd5ddddd7dd7d5d5ddddddddd5d5d0000000000000000000000000000000000000000000000000000000000000000
dd5d55dddddddd65ddddddddddddddddddd6d5ddddd6dd7d555ddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
5d15155dddddddd55dddddddd66d666666d6dddddddd6d76dddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
5dd55ddddddddddd5dddd66666d666666666dddddd66766d65555555551111110000000000000000000000000000000000000000000000000000000000000000
dddddddddddddd6dddddddddddd66666ddd550000155d66611110000011111110000000000000000000000000000000000000000000000000000000000000000
dddddddddddddd6dd66666ddd5dddddd5dd55111100005d100111111111000110000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddd5555555dd6666ddddd55555dd555d000000001011000110000000000000000000000000000000000000000000000000000000000000000
ddddddddd6666666666666667777777766dd55dd66776d65dd5d5555555115550000000000000000000000000000000000000000000000000000000000000000
ddddddd666666666666677777777777777666666666666666d1d666dd555555d0000000000000000000000000000000000000000000000000000000000000000
dddddddddd666666766777777777777777776666666666666d5d6d5d6776dddd0000000000000000000000000000000000000000000000000000000000000000
666ddddd6666666677777777777777777666666666666666665515d6677766d60000000000000000000000000000000000000000000000000000000000000000
6666666d66666666676666666676666666666666666667d655dddddddd66666d0000000000000000000000000000000000000000000000000000000000000000
666666666666666666666666666666666666666666666dddd6666666dd666d6d0000000000000000000000000000000000000000000000000000000000000000
dd666666d666666ddd66666d66666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddddddddddd666dd666d666666666666666666666666666d60000000000000000000000000000000000000000000000000000000000000000
ddddddddddddddd55dddddddddd6dd6ddddd6ddd66ddd6666666666666ddd6660000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddd55dddddddddddddddddddddddddddddddddd66666d66666d0000000000000000000000000000000000000000000000000000000000000000
ddddddddddddddddddddddddddddddd6dddddddddddddddddd666ddddddddd6d0000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddddddddddddddddddddddddddddddddddddddd6d666d66666d0000000000000000000000000000000000000000000000000000000000000000
666dddddddddddddddddddddddddddddddddddddddd55ddddddddd66666666dd0000000000000000000000000000000000000000000000000000000000000000
6d6ddddddddd6ddddddddddddddddddddddddddddddddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
